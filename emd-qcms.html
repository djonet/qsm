<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMD QCMs - Qcms BY DJO</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
  body {
    font-family: 'Cairo', Arial, sans-serif;
    direction: ltr;
    background: radial-gradient(circle at top, #d9faff, #aee4f5, #7fd4e8);
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh; color: #111;
    position: relative; overflow-x: hidden;
  }
  .bg-illustration {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: url('A_2D_digital_illustration_login_and_registration_s.png') center/cover no-repeat;
    opacity: 0.07; z-index: 0;
  }
  .container {
    background: rgba(255,255,255,0.9);
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    padding: 30px;
    width: 700px; max-width: 95%;
    margin-top: 60px; text-align: center;
    position: relative; z-index: 1;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.7s ease;
  }
  @keyframes fadeIn { from {opacity:0;transform:scale(0.97);} to {opacity:1;transform:scale(1);} }

  h2 { color:#023047; font-weight:800; margin-bottom:5px; }
  .info { font-weight:600; color:#1d3557; margin-bottom:20px; }

  .qcm { background:white; color:#111; border-radius:18px; padding:20px; margin:20px 0;
         box-shadow:0 3px 15px rgba(0,0,0,0.08); text-align:left; transition:all 0.3s ease; }
  .qcm:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,0.15); }

  .question { font-weight:bold; font-size:17px; color:#14213d; margin-bottom:10px; }

  .answers { display:flex; flex-direction:column; gap:8px; }
  .answer {
    position:relative; border:1px solid #ccc; padding:12px 14px 12px 42px;
    border-radius:10px; cursor:pointer; transition:all 0.25s ease; background-color:#f8fafc;
  }
  .answer::before {
    content:""; position:absolute; left:12px; width:20px; height:20px; border-radius:50%;
    border:2px solid #999; background:#fff; transition:all 0.25s ease;
  }
  .answer:hover { background-color:#e6faff; }
  .answer.selected::before { background:radial-gradient(circle at center,#219ebc 50%,#023047 100%); border-color:transparent; }
  .answer.selected { background-color:#caf0f8; border-color:#00b4d8; }

  .answer.correct::before { background:#38b000; border-color:#38b000; }
  .answer.incorrect::before { background:#e63946; border-color:#e63946; }
  .answer.correct { background-color:#c7f9cc; border-color:#38b000; }
  .answer.incorrect { background-color:#ffccd5; border-color:#e63946; }

  /* ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ */
  .control-buttons {
    margin-top:14px; display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:nowrap;
  }
  button { border:none; border-radius:12px; padding:10px 18px; cursor:pointer;
           font-weight:bold; transition:all 0.25s ease; }
  .submit-btn { background:linear-gradient(135deg,#00b4d8,#48cae4); color:white; }
  .submit-btn:hover { background:linear-gradient(135deg,#48cae4,#00b4d8); transform:translateY(-2px); }
  .reset-btn { background:#14213d; color:white; }
  .reset-btn:hover { background:#1d3557; transform:translateY(-2px); }
  .show-solution-btn { background:linear-gradient(135deg,#ffb703,#fb8500); color:#111; }

  /* ====== Feedback XXL ====== */
  .qcm .feedback{
    display: flex; align-items: center; justify-content: center;
    width: 100%; min-height: 88px; margin: 16px 0 0;
    padding: 18px 20px; border-radius: 14px;
    font-weight: 800; text-align: center; letter-spacing: 0.4px;
    font-size: clamp(20px, 3.6vw, 34px);
    border: 1px solid transparent; box-shadow: 0 6px 18px rgba(0,0,0,0.10);
  }
  .qcm .feedback.correct{
    background: linear-gradient(135deg,#d9fbe3,#b7f0c6);
    color: #0a4e21; border-color:#9de2b1;
  }
  .qcm .feedback.incorrect{
    background: linear-gradient(135deg,#ffe3e7,#ffc9cf);
    color:#7e1016; border-color:#f3a3ac;
  }

  @keyframes shakeX {
    0%,100% { transform: translateX(0); }
    15% { transform: translateX(-8px); }
    30% { transform: translateX(8px); }
    45% { transform: translateX(-6px); }
    60% { transform: translateX(6px); }
    75% { transform: translateX(-3px); }
    90% { transform: translateX(3px); }
  }
  @keyframes successPop {
    0% { transform: scale(0.98); box-shadow: 0 0 0 0 rgba(56,176,0,0.35); }
    60% { transform: scale(1.03); box-shadow: 0 0 0 14px rgba(56,176,0,0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(56,176,0,0); }
  }
  .qcm .feedback.animate.correct{ animation: successPop 700ms ease; }
  .qcm .feedback.animate.incorrect{ animation: shakeX 500ms ease; }

  @media(max-width:480px){
    .container{padding:18px;margin-top:40px;}
    .question{font-size:15px;}
    .control-buttons button { padding:8px 12px; font-size:14px; }
    .feedback { min-width: auto; width: 100%; }
  }
</style>
</head>
<body>

<div class="bg-illustration"></div>
<div class="container" id="secureArea" style="display:none;">
  <h2>ü¶∑ EMD QCMs</h2>
  <div class="info">
    Ann√©e: <span id="year"></span> |
    EMD: <span id="emd"></span> |
    Mati√®re: <span id="subject"></span>
  </div>
  <div id="qcm-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- üîê Firebase Auth -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBldr32JPJGdMyZZBT1PD2eHvE48QkVtU8",
    authDomain: "qcm-djo.firebaseapp.com",
    projectId: "qcm-djo",
    storageBucket: "qcm-djo.appspot.com",
    messagingSenderId: "384943172069",
    appId: "1:384943172069:web:6b59c1b9b31f2fe097a70c",
    measurementId: "G-13MC1GT4HM"
  };

  document.documentElement.style.visibility = 'hidden';
  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function generateDeviceId() {
    return btoa(navigator.userAgent + screen.width + screen.height + navigator.language);
  }

  async function ensureDeviceRegistered(user) {
    const ref = doc(db, "devices", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { deviceId: generateDeviceId() });
      console.log("‚úÖ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑŸá ŸÑÿ£ŸàŸÑ ŸÖÿ±ÿ©");
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.replace('index.html');
      return;
    }
    try {
      const ref = doc(db, "allowedUsers", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        await ensureDeviceRegistered(user);
        document.documentElement.style.visibility = 'visible';
        document.getElementById("secureArea").style.display = "block";
        startEMDPage();
      } else {
        window.location.replace('welcome.html?status=pending');
      }
    } catch (e) {
      console.error("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ:", e);
      window.location.replace('welcome.html?status=pending');
    }
  });
</script>

<script src="qcms-data.js"></script>
<script>
window.startEMDPage = function() {
  const params = new URLSearchParams(window.location.search);
  const year = params.get("year") || 2024;
  const emd = params.get("emd") || 1;
  const subject = params.get("subject") || "Anatomie dentaire";
  document.getElementById("year").textContent = year;
  document.getElementById("emd").textContent = emd;
  document.getElementById("subject").textContent = subject;

  const container = document.getElementById("qcm-container");
  const questions = QCMS?.[year]?.[emd]?.[subject] || [];

  if (!Array.isArray(questions) || questions.length === 0) {
    container.innerHTML = `<div class="qcm">Aucun QCM ajout√© pour <b>${subject}</b> (Ann√©e ${year} / EMD ${emd}).</div>`;
  } else {
    questions.forEach((qcm) => {
      const block = document.createElement("div");
      block.className = "qcm";

      const question = document.createElement("div");
      question.className = "question";
      question.textContent = qcm.question;
      block.appendChild(question);

      const answersDiv = document.createElement("div");
      answersDiv.className = "answers";
      block.appendChild(answersDiv);

      const selectedAnswers = new Set();
      const correctAnswers = qcm.answers.filter(a => a.correct).map(a => a.text);

      qcm.answers.forEach(a => {
        const ans = document.createElement("div");
        ans.className = "answer";
        ans.textContent = a.text;
        ans.onclick = () => {
          if (selectedAnswers.has(a.text)) {
            selectedAnswers.delete(a.text);
            ans.classList.remove("selected");
          } else {
            selectedAnswers.add(a.text);
            ans.classList.add("selected");
          }
        };
        answersDiv.appendChild(ans);
      });

      const controlDiv = document.createElement("div");
      controlDiv.className = "control-buttons";

      const submitBtn = document.createElement("button");
      submitBtn.className = "submit-btn";
      submitBtn.textContent = "Ÿáÿ∞Ÿá ŸáŸä ÿ•ÿ¨ÿßÿ®ÿ™Ÿä";

      const showBtn = document.createElement("button");
      showBtn.className = "show-solution-btn";
      showBtn.textContent = "üí° ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©";
      showBtn.style.display = "none";

      const resetBtn = document.createElement("button");
      resetBtn.className = "reset-btn";
      resetBtn.textContent = "ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©";

      controlDiv.appendChild(submitBtn);
      controlDiv.appendChild(showBtn);
      controlDiv.appendChild(resetBtn);
      block.appendChild(controlDiv);

      submitBtn.onclick = () => {
        const selectedArray = Array.from(selectedAnswers);
        block.querySelectorAll(".feedback").forEach(f => f.remove());
        let text = "", cls = "";
        if (!selectedArray.length) { text = "‚ùó ŸÑŸÖ ÿ™ÿÆÿ™ÿ± ÿ£Ÿä ÿ•ÿ¨ÿßÿ®ÿ©"; cls = "incorrect"; }
        else if (selectedArray.length === correctAnswers.length && selectedArray.every(t => correctAnswers.includes(t))) {
          text = "‚úÖ ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ÿµÿ≠Ÿäÿ≠ÿ©!"; cls = "correct";
        } else { text = "‚ùå ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ÿÆÿßÿ∑ÿ¶ÿ©"; cls = "incorrect"; }

        const feedback = document.createElement("div");
        feedback.className = `feedback ${cls} animate`;
        feedback.textContent = text;
        block.appendChild(feedback);

        if (cls === "correct" && window.confetti) {
          confetti({ particleCount: 70, spread: 55, origin: { y: 0.7 } });
        }

        showBtn.style.display = "inline-block";
      };

      resetBtn.onclick = () => {
        selectedAnswers.clear();
        block.querySelectorAll(".answer").forEach(ans => ans.classList.remove("selected","correct","incorrect"));
        block.querySelectorAll(".feedback").forEach(e => e.remove());
        showBtn.style.display = "none";
      };

      showBtn.onclick = () => {
        block.querySelectorAll(".answer").forEach(ans => {
          if (correctAnswers.includes(ans.textContent)) ans.classList.add("correct");
          else ans.classList.add("incorrect");
        });
      };

      container.appendChild(block);
    });
  }
};
</script>
<script src="security.js"></script>
</body>
</html>
